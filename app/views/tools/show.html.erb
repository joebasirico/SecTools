<div class="min-h-screen" style="background-color: var(--color-bg-primary);">
  <div class="container mx-auto px-4 py-8 max-w-4xl">
    <div class="mb-6">
      <%= link_to root_path, class: "theme-link inline-flex items-center font-mono text-sm transition-colors" do %>
        <span class="mr-2">←</span>
        <span>BACK TO ARSENAL</span>
      <% end %>
    </div>

    <% if @tool_class %>
      <header class="mb-8 theme-card">
        <div class="flex items-center mb-3">
          <span class="text-2xl mr-3" style="color: var(--color-primary);">▶</span>
          <h1 class="text-3xl font-bold theme-header" style="color: var(--color-text-primary);"><%= @tool_class.tool_name %></h1>
        </div>
        <p class="mb-3 font-mono text-sm" style="color: var(--color-text-secondary);"><%= @tool_class.tool_description %></p>
        <div class="inline-block px-3 py-1 border rounded text-xs font-mono" style="background-color: var(--color-bg-secondary); border-color: var(--color-border); color: var(--color-text-primary);">
          [ <%= @tool_class.tool_category.upcase %> ]
        </div>
      </header>

      <% if flash[:alert] %>
        <div class="border-2 px-4 py-3 rounded mb-6 font-mono text-sm" style="background-color: var(--color-error); border-color: var(--color-error); color: var(--color-bg-primary); opacity: 0.9;">
          <span class="font-bold">[ERROR]</span> <%= flash[:alert] %>
        </div>
      <% end %>

      <% if @tool_class.name == 'BrowserFingerprintTool' %>
        <!-- Custom form for Browser Fingerprint Tool -->
        <div class="theme-card mb-6">
          <h2 class="text-xl font-bold mb-4 theme-header flex items-center" style="color: var(--color-text-primary);">
            <span class="mr-2">▶</span>
            ANALYZE YOUR BROWSER
          </h2>
          <%= render partial: 'tools/browser_fingerprint_form' %>
        </div>
      <% else %>
        <div class="theme-card mb-6">
          <h2 class="text-xl font-bold mb-4 theme-header flex items-center" style="color: var(--color-text-primary);">
            <span class="mr-2">▶</span>
            INPUT PARAMETERS
          </h2>
          <%= form_with url: execute_tool_path(@tool_instance.class.name.underscore.gsub('_tool', '')),
                        method: :post, local: true, data: { turbo: false }, multipart: true, class: "space-y-4", id: "tool-execution-form" do |f| %>

          <% @tool_class.tool_inputs.each do |input| %>
            <div>
              <label class="block text-sm font-bold mb-2 font-mono" style="color: var(--color-text-primary);">
                > <%= input[:label] %>
                <% if input[:required] %>
                  <span class="text-error">*</span>
                <% end %>
              </label>

              <% case input[:type] %>
              <% when :password %>
                <%= text_field_tag "tool[#{input[:name]}]", params.dig(:tool, input[:name]),
                    type: 'password',
                    placeholder: input[:placeholder],
                    required: input[:required],
                    class: "theme-input w-full" %>
              <% when :file %>
                <div class="file-drop-zone border-2 border-dashed rounded-md p-4 text-center transition-all"
                     style="border-color: var(--color-border);"
                     data-input-name="tool[<%= input[:name] %>]">
                  <div class="drop-zone-content">
                    <div class="mb-2">
                      <svg class="inline-block h-6 w-6" style="color: var(--color-primary);" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                      </svg>
                    </div>
                    <div class="text-sm font-mono mb-2" style="color: var(--color-text-primary);">
                      <label for="file-upload-<%= input[:name] %>" class="relative cursor-pointer rounded-md font-bold" style="color: var(--color-primary);">
                        <span>Click to upload</span>
                        <%= file_field_tag "tool[#{input[:name]}]",
                            accept: input[:options][:accept] || '*',
                            required: input[:required],
                            id: "file-upload-#{input[:name]}",
                            class: "sr-only" %>
                      </label>
                      <span style="color: var(--color-text-secondary);"> or drag and drop</span>
                    </div>
                    <p class="text-xs font-mono" style="color: var(--color-text-muted);"><%= input[:placeholder] %></p>
                    <p class="file-name-display text-xs font-mono mt-2 hidden" style="color: var(--color-text-primary);"></p>
                  </div>
                </div>
              <% when :checkbox %>
                <div class="flex items-center">
                  <%= check_box_tag "tool[#{input[:name]}]", "1", params.dig(:tool, input[:name]) == "1",
                      class: "w-5 h-5 border-2 rounded focus:ring-2 cursor-pointer",
                      style: "background-color: var(--color-bg-primary); border-color: var(--color-border); color: var(--color-primary);" %>
                  <span class="ml-3 text-sm font-mono" style="color: var(--color-text-secondary);"><%= input[:placeholder] %></span>
                </div>
              <% when :select %>
                <%= select_tag "tool[#{input[:name]}]",
                    options_for_select(input[:options][:options] || [], params.dig(:tool, input[:name])),
                    prompt: input[:placeholder],
                    required: input[:required],
                    class: "theme-input w-full cursor-pointer" %>
              <% when :text, :url %>
                <%= text_area_tag "tool[#{input[:name]}]", params.dig(:tool, input[:name]),
                    placeholder: input[:placeholder],
                    required: input[:required],
                    rows: 3,
                    class: "theme-input w-full" %>
              <% else %>
                <%= text_field_tag "tool[#{input[:name]}]", params.dig(:tool, input[:name]),
                    placeholder: input[:placeholder],
                    required: input[:required],
                    class: "theme-input w-full" %>
              <% end %>
            </div>
          <% end %>

          <div class="pt-2">
            <%= submit_tag "[ EXECUTE ANALYSIS ]",
                class: "w-full theme-button cursor-pointer font-mono text-sm tracking-wider" %>
          </div>
        <% end %>
      </div>
      <% end %>

      <!-- Debug: @result present? <%= @result.present? %>, @formatted_result present? <%= @formatted_result.present? %> -->

      <!-- Loading Spinner -->
      <div id="loading-spinner" class="theme-card hidden" style="display: none;">
        <div class="text-center py-12">
          <div class="inline-block relative">
            <!-- Animated spinner -->
            <div class="w-20 h-20 border-4 rounded-full animate-spin" style="border-color: var(--color-bg-tertiary); border-top-color: var(--color-primary);"></div>
            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
              <svg class="w-8 h-8" style="color: var(--color-primary);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
              </svg>
            </div>
          </div>
          <div class="mt-6 font-mono" style="color: var(--color-text-primary);">
            <div class="text-xl font-bold mb-2">[ ANALYZING... ]</div>
            <div class="text-sm" style="color: var(--color-text-muted);">
              <span id="loading-message">Executing security scan</span>
              <span class="loading-dots">
                <span class="dot-1">.</span>
                <span class="dot-2">.</span>
                <span class="dot-3">.</span>
              </span>
            </div>
            <% if @tool_class.name == 'SslSecurityTesterTool' %>
              <div class="mt-4 text-xs space-y-1" style="color: var(--color-text-muted);">
                <div>→ Testing TLS/SSL protocols</div>
                <div>→ Enumerating cipher suites</div>
                <div>→ Analyzing certificate</div>
                <div>→ Checking vulnerabilities</div>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <% if @result.present? %>
        <div class="theme-card" id="results-container" style="display: block;">
          <h2 class="text-xl font-bold mb-4 theme-header flex items-center" style="color: var(--color-text-primary);">
            <span class="mr-2">▶</span>
            SCAN RESULTS
          </h2>

          <% if @tool_class.name == 'BrowserFingerprintTool' %>
            <%= render partial: 'tools/browser_fingerprint_results', locals: { result: @result } %>
          <% elsif @tool_class.name == 'DepValidatorTool' %>
            <%= render partial: 'tools/dependency_tree', locals: { result: @result } %>
          <% elsif @tool_class.name == 'CodeSecurityScannerTool' %>
            <%= render partial: 'tools/code_security_results', locals: { result: @result } %>
          <% elsif @tool_class.name == 'SslSecurityTesterTool' %>
            <%= render partial: 'tools/ssl_security_results', locals: { result: @result } %>
          <% elsif @tool_class.name == 'SwaggerScannerTool' %>
            <%= render partial: 'tools/swagger_scanner_results', locals: { result: @result } %>
          <% elsif @tool_class.name == 'ApiSchemaSecurityReviewerTool' %>
            <%= render partial: 'tools/api_schema_security_results', locals: { result: @result } %>
          <% elsif @result.is_a?(Hash) %>
            <div class="space-y-4">
              <% @result.each do |key, value| %>
                <div class="border-b pb-3" style="border-color: var(--color-border);">
                  <dt class="text-xs font-bold mb-2 font-mono uppercase tracking-wider" style="color: var(--color-text-muted);">
                    > <%= key.to_s.gsub('_', ' ') %>
                  </dt>
                  <dd class="font-mono text-sm" style="color: var(--color-text-primary);">
                    <% if value.is_a?(Array) %>
                      <ul class="space-y-2 ml-4">
                        <% value.each do |item| %>
                          <li class="<%= severity_class(item) if item.is_a?(Hash) && item[:severity] %> flex items-start">
                            <span class="mr-2">•</span>
                            <span><%= item.is_a?(Hash) ? render_hash(item) : item %></span>
                          </li>
                        <% end %>
                      </ul>
                    <% elsif value.is_a?(Hash) %>
                      <div class="ml-4 p-3 rounded border" style="background-color: var(--color-bg-secondary); border-color: var(--color-border);">
                        <%= render_hash(value) %>
                      </div>
                    <% else %>
                      <span class="<%= result_class(key, value) %>">
                        <%= value %>
                      </span>
                    <% end %>
                  </dd>
                </div>
              <% end %>
            </div>
          <% else %>
            <pre class="p-4 rounded border-2 overflow-x-auto font-mono text-sm" style="background-color: var(--color-bg-secondary); border-color: var(--color-border); color: var(--color-text-primary);"><%= @formatted_result %></pre>
          <% end %>
        </div>
      <% end %>

      <!-- Source Code Display for Password Strength Tool -->
      <% if @tool_class && @tool_class.name == 'PasswordStrengthTool' %>
        <%= render partial: 'tools/password_strength_source' %>
      <% end %>
    <% end %>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Form submission handler for loading spinner
    const form = document.getElementById('tool-execution-form');
    const loadingSpinner = document.getElementById('loading-spinner');
    const resultsContainer = document.getElementById('results-container');

    if (form) {
      form.addEventListener('submit', (e) => {
        // Hide existing results
        if (resultsContainer) {
          resultsContainer.style.display = 'none';
        }

        // Show loading spinner
        if (loadingSpinner) {
          loadingSpinner.classList.remove('hidden');
          loadingSpinner.style.display = 'block';

          // Scroll to spinner
          loadingSpinner.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Form will submit normally, spinner will be hidden on page reload
      });
    }

    // File drop zone handling
    const dropZones = document.querySelectorAll('.file-drop-zone');

    dropZones.forEach(dropZone => {
      const fileInput = dropZone.querySelector('input[type="file"]');
      const fileNameDisplay = dropZone.querySelector('.file-name-display');

      // Prevent default drag behaviors
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
      });

      // Highlight drop zone when dragging over it
      ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
          dropZone.style.borderColor = 'var(--color-primary-hover)';
          dropZone.style.backgroundColor = 'var(--color-bg-secondary)';
        }, false);
      });

      ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
          dropZone.style.borderColor = 'var(--color-border)';
          dropZone.style.backgroundColor = '';
        }, false);
      });

      // Handle dropped files
      dropZone.addEventListener('drop', (e) => {
        const dt = e.dataTransfer;
        const files = dt.files;

        if (files.length > 0) {
          // Create a new FileList-like object and assign to input
          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(files[0]);
          fileInput.files = dataTransfer.files;

          // Display file name
          updateFileName(fileInput, fileNameDisplay);
        }
      }, false);

      // Handle file selection via click
      fileInput.addEventListener('change', () => {
        updateFileName(fileInput, fileNameDisplay);
      });
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    function updateFileName(input, display) {
      if (input.files && input.files.length > 0) {
        display.textContent = `Selected: ${input.files[0].name}`;
        display.classList.remove('hidden');
      } else {
        display.textContent = '';
        display.classList.add('hidden');
      }
    }
  });
</script>

<style>
  .file-drop-zone.dragover {
    background-color: rgba(34, 197, 94, 0.1);
  }

  .file-drop-zone svg {
    max-width: 48px !important;
    max-height: 48px !important;
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }

  /* Loading dots animation */
  .loading-dots {
    display: inline-block;
  }

  .loading-dots span {
    animation: blink 1.4s infinite;
    animation-fill-mode: both;
  }

  .loading-dots .dot-1 {
    animation-delay: 0s;
  }

  .loading-dots .dot-2 {
    animation-delay: 0.2s;
  }

  .loading-dots .dot-3 {
    animation-delay: 0.4s;
  }

  @keyframes blink {
    0%, 80%, 100% {
      opacity: 0;
    }
    40% {
      opacity: 1;
    }
  }

  /* Spinner animation */
  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  .animate-spin {
    animation: spin 1s linear infinite;
  }
</style>
