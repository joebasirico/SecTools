<div class="min-h-screen bg-gray-900">
  <div class="container mx-auto px-4 py-8 max-w-4xl">
    <div class="mb-6">
      <%= link_to root_path, class: "inline-flex items-center text-green-400 hover:text-green-300 font-mono text-sm transition-colors" do %>
        <span class="mr-2">←</span>
        <span>BACK TO ARSENAL</span>
      <% end %>
    </div>

    <% if @tool_class %>
      <header class="mb-8 hacker-card">
        <div class="flex items-center mb-3">
          <span class="text-green-500 text-2xl mr-3">▶</span>
          <h1 class="text-3xl font-bold text-green-300 terminal-header"><%= @tool_class.tool_name %></h1>
        </div>
        <p class="text-green-500 mb-3 font-mono text-sm"><%= @tool_class.tool_description %></p>
        <div class="inline-block px-3 py-1 bg-gray-900 border border-green-600 rounded text-green-400 text-xs font-mono">
          [ <%= @tool_class.tool_category.upcase %> ]
        </div>
      </header>

      <% if flash[:alert] %>
        <div class="bg-red-900 border-2 border-red-500 text-red-300 px-4 py-3 rounded mb-6 font-mono text-sm">
          <span class="font-bold">[ERROR]</span> <%= flash[:alert] %>
        </div>
      <% end %>

      <div class="hacker-card mb-6">
        <h2 class="text-xl font-bold text-green-400 mb-4 terminal-header flex items-center">
          <span class="mr-2">▶</span>
          INPUT PARAMETERS
        </h2>
        <%= form_with url: execute_tool_path(@tool_instance.class.name.underscore.gsub('_tool', '')),
                      method: :post, local: true, data: { turbo: false }, multipart: true, class: "space-y-4" do |f| %>

          <% @tool_class.tool_inputs.each do |input| %>
            <div>
              <label class="block text-sm font-bold text-green-400 mb-2 font-mono">
                > <%= input[:label] %>
                <% if input[:required] %>
                  <span class="text-red-500">*</span>
                <% end %>
              </label>

              <% case input[:type] %>
              <% when :password %>
                <%= text_field_tag "tool[#{input[:name]}]", params.dig(:tool, input[:name]),
                    type: 'password',
                    placeholder: input[:placeholder],
                    required: input[:required],
                    class: "w-full px-3 py-2 bg-gray-900 border-2 border-green-600 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 text-green-400 font-mono" %>
              <% when :file %>
                <div class="file-drop-zone border-2 border-dashed border-green-600 rounded-md p-4 text-center transition-all hover:border-green-400 hover:bg-gray-800/50"
                     data-input-name="tool[<%= input[:name] %>]">
                  <div class="drop-zone-content">
                    <div class="mb-2">
                      <svg class="inline-block h-6 w-6 text-green-500" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                      </svg>
                    </div>
                    <div class="text-sm text-green-400 font-mono mb-2">
                      <label for="file-upload-<%= input[:name] %>" class="relative cursor-pointer rounded-md font-bold text-green-300 hover:text-green-200">
                        <span>Click to upload</span>
                        <%= file_field_tag "tool[#{input[:name]}]",
                            accept: '.lock,.json,.txt',
                            required: input[:required],
                            id: "file-upload-#{input[:name]}",
                            class: "sr-only" %>
                      </label>
                      <span class="text-green-500"> or drag and drop</span>
                    </div>
                    <p class="text-xs text-green-600 font-mono"><%= input[:placeholder] %></p>
                    <p class="file-name-display text-xs text-green-300 font-mono mt-2 hidden"></p>
                  </div>
                </div>
              <% when :checkbox %>
                <div class="flex items-center">
                  <%= check_box_tag "tool[#{input[:name]}]", "1", params.dig(:tool, input[:name]) == "1",
                      class: "w-5 h-5 bg-gray-900 border-2 border-green-600 rounded focus:ring-2 focus:ring-green-500 text-green-600 cursor-pointer" %>
                  <span class="ml-3 text-sm text-green-500 font-mono"><%= input[:placeholder] %></span>
                </div>
              <% when :text, :url %>
                <%= text_area_tag "tool[#{input[:name]}]", params.dig(:tool, input[:name]),
                    placeholder: input[:placeholder],
                    required: input[:required],
                    rows: 3,
                    class: "w-full px-3 py-2 bg-gray-900 border-2 border-green-600 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 text-green-400 font-mono" %>
              <% else %>
                <%= text_field_tag "tool[#{input[:name]}]", params.dig(:tool, input[:name]),
                    placeholder: input[:placeholder],
                    required: input[:required],
                    class: "w-full px-3 py-2 bg-gray-900 border-2 border-green-600 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 text-green-400 font-mono" %>
              <% end %>
            </div>
          <% end %>

          <div class="pt-2">
            <%= submit_tag "[ EXECUTE ANALYSIS ]",
                class: "w-full hacker-button cursor-pointer font-mono text-sm tracking-wider" %>
          </div>
        <% end %>
      </div>

      <!-- Debug: @result present? <%= @result.present? %>, @formatted_result present? <%= @formatted_result.present? %> -->

      <% if @result.present? %>
        <div class="hacker-card">
          <h2 class="text-xl font-bold text-green-400 mb-4 terminal-header flex items-center">
            <span class="mr-2">▶</span>
            SCAN RESULTS
          </h2>

          <% if @tool_class.name == 'DepValidatorTool' %>
            <%= render partial: 'tools/dependency_tree', locals: { result: @result } %>
          <% elsif @result.is_a?(Hash) %>
            <div class="space-y-4">
              <% @result.each do |key, value| %>
                <div class="border-b border-green-900 pb-3">
                  <dt class="text-xs font-bold text-green-600 mb-2 font-mono uppercase tracking-wider">
                    > <%= key.to_s.gsub('_', ' ') %>
                  </dt>
                  <dd class="text-green-400 font-mono text-sm">
                    <% if value.is_a?(Array) %>
                      <ul class="space-y-2 ml-4">
                        <% value.each do |item| %>
                          <li class="<%= severity_class(item) if item.is_a?(Hash) && item[:severity] %> flex items-start">
                            <span class="mr-2">•</span>
                            <span><%= item.is_a?(Hash) ? render_hash(item) : item %></span>
                          </li>
                        <% end %>
                      </ul>
                    <% elsif value.is_a?(Hash) %>
                      <div class="ml-4 bg-gray-900 p-3 rounded border border-green-700">
                        <%= render_hash(value) %>
                      </div>
                    <% else %>
                      <span class="<%= result_class(key, value) %>">
                        <%= value %>
                      </span>
                    <% end %>
                  </dd>
                </div>
              <% end %>
            </div>
          <% else %>
            <pre class="bg-gray-900 p-4 rounded border-2 border-green-700 overflow-x-auto text-green-400 font-mono text-sm"><%= @formatted_result %></pre>
          <% end %>
        </div>
      <% end %>
    <% end %>
  </div>
</div>

<%# Helper methods for styling %>
<%
  def severity_class(item)
    return '' unless item.is_a?(Hash) && item[:severity]
    case item[:severity]
    when :critical then 'text-red-400 font-bold'
    when :high then 'text-red-500'
    when :medium then 'text-yellow-500'
    when :low then 'text-yellow-400'
    else ''
    end
  end

  def result_class(key, value)
    return 'text-green-300 font-semibold' if key.to_s.include?('score') && value.to_i > 70
    return 'text-red-400 font-semibold' if key.to_s.include?('expired') && value == true
    return 'text-yellow-400 font-semibold' if key.to_s.include?('warning')
    'text-green-400'
  end

  def render_hash(hash)
    content_tag(:div, class: 'space-y-1') do
      hash.map do |k, v|
        content_tag(:div, class: 'flex') do
          concat content_tag(:span, "#{k.to_s.gsub('_', ' ')}: ", class: 'font-bold text-green-600 mr-2')
          concat content_tag(:span, v.is_a?(Hash) || v.is_a?(Array) ? v.inspect : v.to_s, class: 'text-green-400')
        end
      end.join.html_safe
    end
  end
%>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const dropZones = document.querySelectorAll('.file-drop-zone');

    dropZones.forEach(dropZone => {
      const fileInput = dropZone.querySelector('input[type="file"]');
      const fileNameDisplay = dropZone.querySelector('.file-name-display');

      // Prevent default drag behaviors
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
      });

      // Highlight drop zone when dragging over it
      ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
          dropZone.classList.add('border-green-400', 'bg-gray-800');
          dropZone.classList.remove('border-green-600');
        }, false);
      });

      ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
          dropZone.classList.remove('border-green-400', 'bg-gray-800');
          dropZone.classList.add('border-green-600');
        }, false);
      });

      // Handle dropped files
      dropZone.addEventListener('drop', (e) => {
        const dt = e.dataTransfer;
        const files = dt.files;

        if (files.length > 0) {
          // Create a new FileList-like object and assign to input
          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(files[0]);
          fileInput.files = dataTransfer.files;

          // Display file name
          updateFileName(fileInput, fileNameDisplay);
        }
      }, false);

      // Handle file selection via click
      fileInput.addEventListener('change', () => {
        updateFileName(fileInput, fileNameDisplay);
      });
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    function updateFileName(input, display) {
      if (input.files && input.files.length > 0) {
        display.textContent = `Selected: ${input.files[0].name}`;
        display.classList.remove('hidden');
      } else {
        display.textContent = '';
        display.classList.add('hidden');
      }
    }
  });
</script>

<style>
  .file-drop-zone.dragover {
    background-color: rgba(34, 197, 94, 0.1);
  }

  .file-drop-zone svg {
    max-width: 48px !important;
    max-height: 48px !important;
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }
</style>
