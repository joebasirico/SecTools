<!-- Prism.js CSS (Dark Theme) -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />

<div class="mt-6 p-6 rounded-lg" style="background-color: rgba(34, 197, 94, 0.1); border-left: 4px solid var(--color-success);">
  <p class="font-mono text-sm mb-4" style="color: var(--color-text-primary);">
    <strong style="font-size: 1.1em;">üîí Transparency Notice</strong>
  </p>

  <p class="font-mono text-sm mb-4" style="color: var(--color-text-secondary);">
    <strong style="color: var(--color-warning);">‚ö†Ô∏è Important:</strong> This tool is for testing password strength patterns only.
    Never test passwords that are currently in use.
  </p>

  <p class="font-mono text-sm mb-3" style="color: var(--color-text-primary);">
    <strong>This tool analyzes passwords in memory for:</strong>
  </p>

  <ul class="font-mono text-sm mb-4 ml-6 space-y-1" style="color: var(--color-text-secondary); list-style-type: disc;">
    <li>Length and complexity</li>
    <li>Character types (uppercase, lowercase, numbers, special)</li>
    <li>Common patterns and sequences</li>
    <li>Bits of entropy</li>
    <li>Estimated crack time</li>
    <li>Whether it appears in breach databases (via <a href="https://haveibeenpwned.com" target="_blank" rel="noopener" style="color: var(--color-primary); text-decoration: underline;">Have I Been Pwned</a>)</li>
  </ul>

  <p class="font-mono text-sm" style="color: var(--color-text-primary);">
    <strong style="color: var(--color-success);">‚úì Your password is NEVER stored or logged</strong> - it's only processed in memory for analysis.
    The complete source code is available below for review.
  </p>
</div>
<!-- Source Code Section -->
<details class="border-2 rounded-lg mt-6" style="background-color: var(--color-bg-secondary); border-color: var(--color-border);">
  <summary class="p-4 cursor-pointer font-mono text-sm font-bold flex items-center" style="color: var(--color-text-primary);">
    <svg class="w-5 h-5 mr-2" style="color: var(--color-primary);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
    </svg>
    <span>‚ñ∂ VIEW SOURCE CODE</span>
    <span class="ml-2 text-xs" style="color: var(--color-text-muted);">(Click to expand)</span>
  </summary>

    <div class="border rounded" style="border-color: var(--color-border); overflow: hidden;">
      <div class="px-4 py-2 border-b flex items-center justify-between" style="background-color: #2d2d30; border-color: var(--color-border);">
        <span class="font-mono text-xs" style="color: #d4d4d4;">
          <span style="color: #569cd6;">üìÑ</span> password_strength_tool.rb
        </span>
        <button onclick="copyPasswordSourceCode()" id="copy-btn" class="px-3 py-1 rounded font-mono text-xs transition-colors" style="background-color: var(--color-primary); color: var(--color-bg-primary);">
          Copy Code
        </button>
      </div>

      <pre class="!m-0 !rounded-none"><code id="password-source-code" class="language-ruby"># frozen_string_literal: true

require 'digest'
require 'net/http'

# Password Strength Analyzer with Have I Been Pwned Integration
# Analyzes password strength and checks against breach database
class PasswordStrengthTool
  include SecurityTool

  configure_tool(
    name: "Password Strength Analyzer",
    description: "Analyze password strength and check against Have I Been Pwned breach database",
    category: "Authentication Security"
  )

  input_field :password, type: :password, label: "Password to Test", placeholder: "Enter password", required: true
  output_format :html, :json

  def execute(params)
    password = params[:password]

    # Calculate basic metrics
    score = calculate_score(password)
    feedback = generate_feedback(password, score)
    entropy = calculate_entropy(password)
    crack_time = estimate_crack_time(password)

    # Check against Have I Been Pwned
    pwned_data = check_pwned(password)

    {
      password_length: password.length,
      score: score,
      strength: strength_label(score),
      entropy_bits: entropy,
      estimated_crack_time: crack_time,
      character_types: analyze_character_types(password),
      pwned_status: pwned_data[:status],
      pwned_count: pwned_data[:count],
      feedback: feedback
    }
  end

  private

  def calculate_score(password)
    score = 0

    # Length scoring
    score += 1 if password.length >= 8
    score += 1 if password.length >= 12
    score += 1 if password.length >= 16
    score += 1 if password.length >= 20

    # Character diversity
    score += 1 if password.match?(/[a-z]/)
    score += 1 if password.match?(/[A-Z]/)
    score += 1 if password.match?(/[0-9]/)
    score += 1 if password.match?(/[^a-zA-Z0-9]/)

    # Pattern detection (penalties)
    score -= 1 if password.match?(/(.)\1{2,}/) # Repeated characters
    score -= 1 if password.match?(/123|234|345|456|567|678|789|890/) # Sequential numbers
    score -= 1 if password.match?(/abc|bcd|cde|def|efg|fgh|ghi|hij|ijk|jkl|klm|lmn|mno|nop|opq|pqr|qrs|rst|stu|tuv|uvw|vwx|wxy|xyz/i) # Sequential letters
    score -= 2 if common_password?(password)

    [ [ score, 0 ].max, 10 ].min
  end

  def strength_label(score)
    case score
    when 0..2 then "Very Weak"
    when 3..4 then "Weak"
    when 5..6 then "Moderate"
    when 7..8 then "Strong"
    else "Very Strong"
    end
  end

  def analyze_character_types(password)
    types = []
    types << "lowercase" if password.match?(/[a-z]/)
    types << "uppercase" if password.match?(/[A-Z]/)
    types << "numbers" if password.match?(/[0-9]/)
    types << "special" if password.match?(/[^a-zA-Z0-9]/)
    types.join(", ")
  end

  def calculate_entropy(password)
    charset_size = 0
    charset_size += 26 if password.match?(/[a-z]/)
    charset_size += 26 if password.match?(/[A-Z]/)
    charset_size += 10 if password.match?(/[0-9]/)
    charset_size += 32 if password.match?(/[^a-zA-Z0-9]/)

    return 0 if charset_size == 0

    (password.length * Math.log2(charset_size)).round(2)
  end

  def estimate_crack_time(password)
    entropy = calculate_entropy(password)

    # Assuming 10 billion guesses per second (modern GPU)
    seconds = (2 ** entropy) / 10_000_000_000

    format_time(seconds)
  end

  def format_time(seconds)
    return "Instant" if seconds < 1
    return "#{seconds.round} seconds" if seconds < 60
    return "#{(seconds / 60).round} minutes" if seconds < 3600
    return "#{(seconds / 3600).round} hours" if seconds < 86400
    return "#{(seconds / 86400).round} days" if seconds < 2592000
    return "#{(seconds / 2592000).round} months" if seconds < 31536000

    years = (seconds / 31536000).round
    return "#{years} years" if years < 1000
    return "#{years} years (millennia)" if years < 1_000_000
    "#{years} years (geological timescale)"
  end

  def common_password?(password)
    # Top 100 most common passwords
    common = %w[
      password 123456 12345678 qwerty abc123 monkey letmein trustno1 dragon
      baseball iloveyou master sunshine princess football shadow 123123
      654321 superman michael ninja mustang password1 123456789 password123
      welcome login admin 1234567890 solo passw0rd starwars jesus 1234567
      1234 666666 mypass fuck password321 696969 1q2w3e4r qwertyuiop
      computer donald michael1 daniel sunshine1 michelle computer1 freedom
      whatever lovely buster jennifer babygirl family2012 liverpool
      iloveyou1 football1 charlie pokemon secret superman1 love123 dallas
      london ashley 12345 pepper george charlie1 123321 summer hunter
      target love samsung hello1 ashley1 anthony charlie2 oliver cookie
      orange amanda jessica zxcvbnm michelle1 party ranger access whatever1
      michelle2 love jordan google jackson batman lovely1 money
    ]

    common.include?(password.downcase)
  end

  def check_pwned(password)
    begin
      # Create SHA-1 hash of password
      hash = Digest::SHA1.hexdigest(password).upcase
      prefix = hash[0..4]
      suffix = hash[5..-1]

      # Query Have I Been Pwned API (k-Anonymity model)
      uri = URI("https://api.pwnedpasswords.com/range/#{prefix}")
      http = Net::HTTP.new(uri.host, uri.port)
      http.use_ssl = true
      http.verify_mode = OpenSSL::SSL::VERIFY_NONE
      http.open_timeout = 5
      http.read_timeout = 5

      request = Net::HTTP::Get.new(uri)
      request['User-Agent'] = 'SecTools-PasswordChecker'

      response = http.request(request)

      if response.code == '200'
        # Parse response to find suffix match
        response.body.each_line do |line|
          hash_suffix, count = line.strip.split(':')
          if hash_suffix == suffix
            count_num = count.to_i
            return {
              status: "COMPROMISED",
              count: count_num,
              message: "This password has been seen #{count_num} times in data breaches"
            }
          end
        end

        return {
          status: "SAFE",
          count: 0,
          message: "Not found in breach database"
        }
      else
        puts "not 200: #{response.code}"
        return {
          status: "ERROR",
          count: nil,
          message: "Could not check breach database (API error)"
        }
      end
    rescue StandardError => e
      puts e.message
      return {
        status: "ERROR",
        count: nil,
        message: "Could not check breach database: #{e.message}"
      }
    end
  end
end

PasswordStrengthTool.register!</code></pre>
    </div>

    <div class="mt-4 p-3 rounded text-xs font-mono" style="background-color: rgba(34, 197, 94, 0.1); border-left: 4px solid var(--color-success);">
      <p class="font-bold mb-2" style="color: var(--color-success);">üîí Security Notes:</p>
      <ul class="space-y-1 ml-4" style="color: var(--color-text-secondary);">
        <li>‚Ä¢ Your password is <strong>only processed in memory</strong> and never stored</li>
        <li>‚Ä¢ Have I Been Pwned uses <strong>k-Anonymity</strong>: only the first 5 characters of the SHA-1 hash are sent</li>
        <li>‚Ä¢ The full password hash never leaves your device</li>
        <li>‚Ä¢ All processing happens server-side in real-time</li>
        <li>‚Ä¢ No logs are kept of passwords tested</li>
      </ul>
    </div>
  </div>
</details>

<!-- Prism.js JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-ruby.min.js"></script>

<script>
function copyPasswordSourceCode() {
  const code = document.getElementById('password-source-code').textContent;
  const btn = document.getElementById('copy-btn');

  navigator.clipboard.writeText(code).then(() => {
    const originalText = btn.textContent;
    const originalBg = btn.style.backgroundColor;

    btn.textContent = '‚úì Copied!';
    btn.style.backgroundColor = '#22c55e';

    setTimeout(() => {
      btn.textContent = originalText;
      btn.style.backgroundColor = originalBg;
    }, 2000);
  }).catch(err => {
    console.error('Failed to copy:', err);
    alert('Failed to copy code');
  });
}

// Apply Prism highlighting when details is opened
document.addEventListener('DOMContentLoaded', function() {
  const details = document.querySelector('details');
  if (details) {
    details.addEventListener('toggle', function() {
      if (details.open) {
        Prism.highlightAll();
      }
    });
  }
});
</script>

<style>
/* Override Prism.js styles to match our theme */
pre[class*="language-"] {
  background: #1e1e1e !important;
  padding: 1rem !important;
  margin: 0 !important;
  font-size: 13px !important;
  line-height: 1.5 !important;
}

code[class*="language-"] {
  background: none !important;
  font-family: 'Courier New', Courier, monospace !important;
}

/* Ensure proper scrolling */
pre[class*="language-"] {
  max-height: 600px;
  overflow: auto;
}
</style>
